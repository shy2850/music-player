import y_playlist_str from"./playlistdata.js";import{dispatch,getState}from"../store.js";import $ from"./../wfquery.js";export const STORE_KEY={LIST:"y_playlist",CURRENT:"y_current",PROGRESS:"y_progress",GUID:"pgv_pvid",CID:"cid"};let y_playlist=localStorage.getItem(STORE_KEY.LIST),y_current=localStorage.getItem(STORE_KEY.CURRENT),y_progress=localStorage.getItem(STORE_KEY.PROGRESS),y_guid=localStorage.getItem(STORE_KEY.GUID)||1392841634,y_cid=localStorage.getItem(STORE_KEY.CID)||205361747;try{y_playlist=JSON.parse(y_playlist)}catch(t){y_playlist=null}y_playlist||(localStorage.setItem(STORE_KEY.LIST,y_playlist_str),y_playlist=JSON.parse(y_playlist_str));let audio=new Audio;audio.autoplay=!0,audio.addEventListener("timeupdate",function(t){const e=100*audio.currentTime/audio.duration;dispatch(t=>t.setIn(["seconds"],audio.currentTime)),updateProgress(e)}),audio.addEventListener("ended",function(t){const e=getState().getIn(["current"]);changeSong(1+e)});export const load=()=>{const t=getState(),e=t.getIn(["list",t.get("current")]).toJS();$.jsonp("https://c.y.qq.com/base/fcgi-bin/fcg_music_express_mobile3.fcg",{g_tk:5738,loginUin:0,hostUin:0,format:"json",inCharset:"utf8",outCharset:"utf-8",notice:0,platform:"yqq",needNewCode:0,cid:y_cid,uin:0,songmid:e.songmid,filename:`C400${e.songmid}.m4a`,guid:y_guid},function(t){const{filename:e,vkey:o}=t.data.items[0];audio.src=`//dl.stream.qqmusic.qq.com/${e}?vkey=${o}&guid=${y_guid}&uin=0&fromtag=66`,audio.play()}),$.ajax({url:"lrc/"+e.songmid+".json",success:function(t){dispatch(e=>e.setIn(["lyric"],t.lyric||"歌词加载失败！"))},error:function(){dispatch(t=>t.setIn(["lyric"],"歌词加载失败！"))}})};export const updateProgress=t=>{dispatch(e=>e.setIn(["progress"],t||0)),localStorage.setItem(STORE_KEY.PROGRESS,t+"")};export const changeProgress=t=>{updateProgress(t),audio.duration*t&&(audio.currentTime=audio.duration*t/100)};export const init=()=>(dispatch(t=>{return t.merge({list:y_playlist,current:(Number(y_current)||0)%(y_playlist.size||1),progress:Number(y_progress)||0})}),changeSong(Number(y_current)||0));export const changeSong=t=>{const e=getState().getIn(["list"]).size;t%=e,localStorage.setItem(STORE_KEY.CURRENT,t+""),localStorage.setItem(STORE_KEY.PROGRESS,"0"),dispatch(e=>e.merge({current:t,progress:0})),load()};